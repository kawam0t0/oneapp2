{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/kawamotoshuntasuku/Desktop/dev/oneapp/app/api/dashboard/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport mysql from \"mysql2/promise\"\n\nconst getConnection = async () => {\n  return await mysql.createConnection({\n    host: process.env.DB_HOST || \"34.67.209.187\",\n    port: Number.parseInt(process.env.DB_PORT || \"3306\"),\n    user: process.env.DB_USER || \"your_username\",\n    password: process.env.DB_PASSWORD || \"your_password\",\n    database: process.env.DB_NAME || \"your_database_name\",\n    ssl: {\n      rejectUnauthorized: false,\n    },\n  })\n}\n\nconst categorizeItem = (details: string): string | null => {\n  if (!details) return \"その他\"\n  if (details.includes(\"高崎棟高店バキューム\")) return null\n  if (details.includes(\"サブスク\")) return \"サブスク\"\n  if (details.includes(\"リピ\")) return \"リピート\"\n  if (details.includes(\"新規\")) return \"新規\"\n  if (details.includes(\"⇒\")) return \"コースアップ\"\n  if (details.includes(\"ポイント\")) return \"ポイント\"\n  if (details.includes(\"キャンペーン\")) return \"キャンペーン\"\n  if (details.includes(\"無料券\")) return \"無料券\"\n  return details\n}\n\nconst categorizeCourse = (details: string): string | null => {\n  if (!details) return null\n  if (details.includes(\"プレミアム\")) return \"プレミアム\"\n  if (details.includes(\"プラス\")) return \"プラス\"\n  if (details.includes(\"ナイアガラ\")) return \"ナイアガラ\"\n  if (details.includes(\"セラミック\")) return \"セラミック\"\n  return null\n}\n\nconst aggregateData = (rows: any[]) => {\n  const storeMap = new Map<string, { items: { [key: string]: number }; total: number }>()\n\n  rows.forEach((row) => {\n    const store = row.store\n    const item = categorizeItem(row.details)\n    const count = row.count\n\n    if (!store || store === \"0\" || store.toString().trim() === \"\") {\n      return\n    }\n\n    if (item === null) {\n      return\n    }\n\n    if (!storeMap.has(store)) {\n      storeMap.set(store, { items: {}, total: 0 })\n    }\n\n    const storeData = storeMap.get(store)!\n    storeData.items[item] = (storeData.items[item] || 0) + count\n    storeData.total += count\n  })\n\n  return Array.from(storeMap.entries()).map(([store, data]) => ({\n    store,\n    items: data.items,\n    total: data.total,\n  }))\n}\n\nconst STORE_ORDER = [\n  \"SPLASH'N'GO!前橋50号店\",\n  \"SPLASH'N'GO!伊勢崎韮塚店\",\n  \"SPLASH'N'GO!高崎棟高店\",\n  \"SPLASH'N'GO!足利緑町店\",\n  \"SPLASH'N'GO!新前橋店\",\n  \"SPLASH'N'GO!太田新田店\",\n]\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const period = searchParams.get(\"period\") || \"2025-11\"\n    const categoriesOnly = searchParams.get(\"categories\") === \"true\"\n\n    const [year, month] = period.split(\"-\")\n\n    const startDate = `${year}-${month}-01`\n    const endDate = new Date(Number.parseInt(year), Number.parseInt(month), 0).getDate()\n    const endDateStr = `${year}-${month}-${endDate}`\n\n    const today = new Date()\n    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, \"0\")}-${String(today.getDate()).padStart(2, \"0\")}`\n\n    const connection = await getConnection()\n\n    if (categoriesOnly) {\n      console.log(\"[v0] Categories only request for period:\", startDate, \"to\", endDateStr)\n\n      const [categoryRows] = await connection.execute(\n        `SELECT store, details, COUNT(*) as count \n         FROM invoice \n         WHERE Date >= ? AND Date <= ?\n         GROUP BY store, details`,\n        [startDate, endDateStr],\n      )\n\n      console.log(\"[v0] Raw category rows count:\", (categoryRows as any[]).length)\n      console.log(\"[v0] Sample rows:\", (categoryRows as any[]).slice(0, 5))\n\n      await connection.end()\n\n      const storeMap = new Map<string, { courses: Map<string, number>; total: number }>()\n      ;(categoryRows as any[]).forEach((row) => {\n        const store = row.store\n        const course = categorizeCourse(row.details)\n        const count = Number(row.count)\n\n        if (!store || store === \"0\" || store.toString().trim() === \"\" || !course) {\n          return\n        }\n\n        if (!storeMap.has(store)) {\n          storeMap.set(store, { courses: new Map(), total: 0 })\n        }\n\n        const storeData = storeMap.get(store)!\n        storeData.courses.set(course, (storeData.courses.get(course) || 0) + count)\n        storeData.total += count\n      })\n\n      console.log(\"[v0] Processed stores:\", Array.from(storeMap.keys()))\n\n      // 店舗順にソートして結果を作成\n      const storeCategories = STORE_ORDER.filter((store) => storeMap.has(store)).map((store) => {\n        const data = storeMap.get(store)!\n        const categories = Array.from(data.courses.entries())\n          .map(([name, value]) => ({\n            name,\n            value,\n            percentage: data.total > 0 ? ((value / data.total) * 100).toFixed(1) : \"0\",\n          }))\n          .sort((a, b) => b.value - a.value)\n\n        return {\n          store,\n          categories,\n          total: data.total,\n        }\n      })\n\n      console.log(\"[v0] Final storeCategories:\", storeCategories)\n\n      return NextResponse.json({\n        storeCategories,\n      })\n    }\n\n    // 通常のリクエスト処理\n    const [monthlyRows] = await connection.execute(\n      `SELECT store, details, COUNT(*) as count \n       FROM onetime \n       WHERE date >= ? AND date <= ?\n       AND (card_entry_method IS NULL OR card_entry_method != 'KEYED')\n       GROUP BY store, details\n       ORDER BY store, details`,\n      [startDate, endDateStr],\n    )\n\n    const [todayRows] = await connection.execute(\n      `SELECT store, details, COUNT(*) as count \n       FROM onetime \n       WHERE date = ?\n       AND (card_entry_method IS NULL OR card_entry_method != 'KEYED')\n       GROUP BY store, details\n       ORDER BY store, details`,\n      [todayStr],\n    )\n\n    const [invoiceRows] = await connection.execute(\n      `SELECT \n         DATE_FORMAT(Date, '%Y-%m') as month,\n         store,\n         COUNT(*) as count\n       FROM invoice\n       WHERE Date >= DATE_SUB(?, INTERVAL 11 MONTH)\n         AND Date <= LAST_DAY(?)\n       GROUP BY DATE_FORMAT(Date, '%Y-%m'), store\n       ORDER BY month ASC, store`,\n      [startDate, endDateStr],\n    )\n\n    await connection.end()\n\n    const monthlyData = aggregateData(monthlyRows as any[])\n    const todayData = aggregateData(todayRows as any[])\n\n    const invoiceDataMap = new Map<string, { [store: string]: number }>()\n    ;(invoiceRows as any[]).forEach((row) => {\n      const month = row.month\n      const store = row.store\n      const count = Number(row.count)\n\n      if (!store || store === \"0\" || store.toString().trim() === \"\") {\n        return\n      }\n\n      if (!invoiceDataMap.has(month)) {\n        invoiceDataMap.set(month, {})\n      }\n\n      invoiceDataMap.get(month)![store] = count\n    })\n\n    const invoiceMonthly = Array.from(invoiceDataMap.entries())\n      .sort((a, b) => a[0].localeCompare(b[0]))\n      .map(([month, stores]) => ({\n        month,\n        ...stores,\n      }))\n\n    return NextResponse.json({\n      monthly: monthlyData,\n      today: todayData,\n      invoiceMonthly,\n    })\n  } catch (error) {\n    console.error(\"[v0] Database error:\", error)\n    return NextResponse.json({ error: \"データベース接続エラー\", details: String(error) }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}